<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hasil Unduhan - All Sosmed Downloader</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-dark: #1e1a30;
    --card-bg: #2b2540;
    --accent-color: #ffc72c;
    --accent-hover: #ffdf7a;
    --text-light: #f0f0f0;
    --text-muted: #a0a0a0;
    --border-color: #443c5b;
}
body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg-dark);
    color: var(--text-light);
    margin: 0; padding: 0;
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh;
}
.container {
    max-width: 900px; width: calc(100% - 40px);
    background-color: var(--card-bg);
    border-radius: 20px; padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
}
.main-title { font-size: 2rem; color: var(--accent-color); margin-bottom:5px; }
.subtitle { font-size:0.9rem;color:var(--text-muted);margin-bottom:25px; }

.video-info { display:flex; align-items:center; gap:15px; text-align:left; margin-bottom:15px; }
.thumbnail { width:80px;height:80px;border-radius:10px;object-fit:cover;flex-shrink:0; }
.video-details { display:flex; flex-direction:column; justify-content:center; min-width:0; }
.video-title { font-weight:600; margin:0 0 5px; overflow:hidden;text-overflow:ellipsis; white-space:nowrap; }
.video-author { font-size:0.85rem;color:var(--text-muted); margin:0; overflow:hidden;text-overflow:ellipsis; white-space:nowrap; }

.download-links { display:flex; flex-direction:column; gap:10px; text-align:left; }
.btn { padding:12px 20px; border-radius:10px; border:none; font-weight:600; cursor:pointer; text-align:center; text-decoration:none; transition:0.2s ease; }
.btn-primary { background-color:var(--accent-color); color:#2b2540; text-transform:uppercase; }
.btn-primary:hover { background-color:var(--accent-hover); transform:translateY(-2px); }
.btn-hd { background-color:#ff5722; color:#fff; }
.btn-hd:hover { background-color:#ff7f50; transform:translateY(-2px); }
.btn-sd { background-color:#556080; color:#fff; }
.btn-sd:hover { background-color:#6a7495; transform:translateY(-2px); }
.btn-mp3 { background-color:#607d8b; color:#fff; }
.btn-mp3:hover { background-color:#78909c; transform:translateY(-2px); }

.download-status-bar { width:100%; height:10px; background-color: #443c5b; border-radius:5px; overflow:hidden; display:none; margin-top:10px; }
.download-progress { height:100%; background-color: var(--accent-color); width:0%; transition: width 0.1s linear; }
.download-progress-text { text-align:center; font-size:0.85rem; margin-top:5px; color:var(--text-muted); }

.message-section { padding:15px; border-radius:10px; margin-top:20px; background-color:#5b3e40; color:#ff9999; display:none; }
</style>
</head>
<body>
<div class="container">
    <h1 class="main-title">Hasil Unduhan Video</h1>
    <p class="subtitle">Pilih opsi unduhan di bawah ini.</p>

    <div class="video-info">
        <img id="videoThumbnail" class="thumbnail" alt="Video thumbnail">
        <div class="video-details">
            <p id="videoTitle" class="video-title"></p>
            <p id="videoAuthor" class="video-author"></p>
        </div>
    </div>

    <div id="downloadLinks" class="download-links"></div>
    <div id="downloadStatusBar" class="download-status-bar">
        <div id="downloadProgress" class="download-progress"></div>
    </div>
    <p id="downloadProgressText" class="download-progress-text"></p>
    <div id="messageSection" class="message-section">
        <p id="messageText"></p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const videoData = JSON.parse(localStorage.getItem('videoData') || 'null');
    const thumbnail = document.getElementById('videoThumbnail');
    const titleEl = document.getElementById('videoTitle');
    const authorEl = document.getElementById('videoAuthor');
    const downloadLinks = document.getElementById('downloadLinks');
    const statusBar = document.getElementById('downloadStatusBar');
    const progressBar = document.getElementById('downloadProgress');
    const progressText = document.getElementById('downloadProgressText');
    const messageSection = document.getElementById('messageSection');
    const messageText = document.getElementById('messageText');

    function showMessage(msg) {
        messageText.textContent = msg;
        messageSection.style.display = 'block';
    }

    function safeText(str) {
        const div = document.createElement('div'); div.textContent = str; return div.innerHTML;
    }

    async function startDownload(url, filename) {
        downloadLinks.style.display = 'none';
        statusBar.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = '0 MB / ...';

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Gagal mengambil file');

            const total = parseInt(response.headers.get('Content-Length'));
            const reader = response.body.getReader();
            let received = 0;
            const chunks = [];

            while(true){
                const {done,value} = await reader.read();
                if(done) break;
                chunks.push(value);
                received += value.length;

                const percent = total ? (received/total*100).toFixed(2) : 0;
                progressBar.style.width = percent + '%';
                const receivedMB = (received/1024/1024).toFixed(2);
                const totalMB = total ? (total/1024/1024).toFixed(2) : '...';
                progressText.textContent = `${receivedMB} MB / ${totalMB} MB`;
            }

            const blob = new Blob(chunks);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            progressText.textContent = 'Unduhan selesai!';
        } catch(err){
            console.error(err);
            progressText.textContent = 'Unduhan gagal!';
            downloadLinks.style.display = 'flex';
        }
    }

    if(videoData){
        thumbnail.src = videoData.thumbnail || '';
        titleEl.innerHTML = safeText(videoData.title || 'Video Tanpa Judul');
        authorEl.innerHTML = safeText(videoData.author?.nickname || 'Tidak Diketahui');

        if(videoData.links?.length){
            videoData.links.forEach(link=>{
                const btn = document.createElement('button');
                btn.className='btn';
                let ext = '';
                if(link.type==='mp4'){
                    btn.textContent = link.quality.toUpperCase()+' Video';
                    btn.classList.add(link.quality==='hd'?'btn-hd':'btn-sd');
                    ext='mp4';
                }else if(link.type==='mp3'){
                    btn.textContent = 'Audio MP3';
                    btn.classList.add('btn-mp3');
                    ext='mp3';
                }
                btn.addEventListener('click', ()=>startDownload(link.url, `video_${Date.now()}.${ext}`));
                downloadLinks.appendChild(btn);
            });
        }else{
            showMessage('Tidak ada tautan unduhan ditemukan.');
        }
    }else{
        showMessage('Gagal memuat data video.');
    }
});
</script>
</body>
</html>
