<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hasil Unduhan - Tiktok Downloader</title>
<meta name="description" content="Unduh video dari TikTok tanpa watermark dengan cepat dan mudah.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-dark: #1e1a30;
    --card-bg: #2b2540;
    --accent-color: #ffc72c;
    --accent-hover: #ffdf7a;
    --text-light: #f0f0f0;
    --text-muted: #a0a0a0;
    --border-color: #443c5b;
}

body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg-dark);
    color: var(--text-light);
    margin: 0;
    padding: 0;
    height: 100vh;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}

.container {
    max-width: 900px;
    width: calc(100% - 40px);
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    background-color: var(--card-bg);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    text-align: center;
    position: relative;
    opacity: 0;
    animation: fadeIn 0.8s ease-out forwards;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.main-title { font-size: 2rem; color: var(--accent-color); margin-bottom: 5px; }
.subtitle { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 25px; }

.download-link {
    background-color: #3b3550;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    text-decoration: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.download-link:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.download-info {
    text-align: left;
}

.download-info h3 {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text-light);
}

.download-info p {
    margin: 2px 0 0;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.download-btn {
    background-color: var(--accent-color);
    color: #2b2540;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    text-transform: uppercase;
    transition: background-color 0.3s ease;
}

.download-btn:hover {
    background-color: var(--accent-hover);
}

.result-section { background-color: #3b3550; padding: 20px; border-radius: 15px; margin-top: 25px; animation: slideIn 0.5s ease-out; }
@keyframes slideIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }

.video-info { display: flex; align-items: flex-start; gap: 15px; text-align: left; margin-bottom: 15px; }
.thumbnail { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; flex-shrink: 0; }
.video-details { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
.video-title { font-weight: 600; margin: 0 0 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.video-author { font-size: 0.85rem; color: var(--text-muted); margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.download-links { display: flex; flex-direction: column; gap: 10px; text-align: left; }

.message-section { padding: 15px; border-radius: 10px; margin-top: 20px; background-color: #5b3e40; color: #ff9999; display: none; }
.message-text { margin: 0; }

.loading-text { font-size: 1rem; color: var(--accent-color); margin-bottom: 10px; text-align: center; }
.spinner { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
@keyframes spin { 0% {transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

.download-status-bar {
    width: 100%;
    height: 10px;
    background-color: #443c5b;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
    display: none;
}

.download-progress {
    height: 100%;
    background-color: var(--accent-color);
    width: 0;
    transition: width 0.1s linear;
}

.download-progress-text {
    text-align: center;
    font-size: 0.85rem;
    margin-top: 5px;
    color: var(--text-muted);
}
</style>
</head>
<body>
<div class="container">
<header class="header">
    <h1 class="main-title">Hasil Unduhan Video</h1>
    <p class="subtitle">Pilih opsi unduhan di bawah ini.</p>
</header>

<main class="main-content">
    <div id="resultSection" class="result-section">
        <div class="video-info">
            <img id="videoThumbnail" class="thumbnail" alt="Video thumbnail">
            <div class="video-details">
                <p id="videoTitle" class="video-title"></p>
                <p id="videoAuthor" class="video-author"></p>
            </div>
        </div>
        <div id="downloadLinks" class="download-links"></div>
        <div id="downloadStatusBar" class="download-status-bar">
            <div id="downloadProgress" class="download-progress"></div>
        </div>
        <p id="downloadProgressText" class="download-progress-text"></p>
        <div id="loadingIndicator" style="display:none;">
            <p class="loading-text">Sedang mengunduh...</p>
            <div class="spinner"></div>
        </div>
    </div>
    <div id="messageSection" class="message-section">
        <p id="messageText" class="message-text"></p>
    </div>
</main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const elements = {
        videoThumbnail: document.getElementById('videoThumbnail'),
        videoTitle: document.getElementById('videoTitle'),
        videoAuthor: document.getElementById('videoAuthor'),
        downloadLinks: document.getElementById('downloadLinks'),
        resultSection: document.getElementById('resultSection'),
        messageSection: document.getElementById('messageSection'),
        messageText: document.getElementById('messageText'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        downloadStatusBar: document.getElementById('downloadStatusBar'),
        downloadProgress: document.getElementById('downloadProgress'),
        downloadProgressText: document.getElementById('downloadProgressText')
    };

    function safeText(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
    function getVideoData() {
        try {
            const dataStr = localStorage.getItem('videoData');
            return dataStr ? JSON.parse(dataStr) : null;
        } catch (e) { console.error(e); return null; }
    }

    function showMessage(msg) {
        if (msg) {
            elements.messageText.textContent = msg;
            elements.messageSection.style.display = 'block';
        } else {
            elements.messageSection.style.display = 'none';
        }
    }

    async function startDownload(url, filename, size) {
        elements.downloadLinks.style.display = 'none';
        elements.downloadStatusBar.style.display = 'block';
        elements.downloadProgressText.style.display = 'block';
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const reader = response.body.getReader();
            const contentLength = response.headers.get('Content-Length');
            let receivedLength = 0;
            const chunks = [];

            while(true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                chunks.push(value);
                receivedLength += value.length;
                
                const progress = (receivedLength / contentLength) * 100;
                elements.downloadProgress.style.width = `${progress}%`;
                
                const receivedMB = (receivedLength / (1024 * 1024)).toFixed(2);
                elements.downloadProgressText.textContent = `${receivedMB} MB / ${size} MB`;
            }

            const blob = new Blob(chunks);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            elements.downloadStatusBar.style.display = 'none';
            elements.downloadProgressText.textContent = 'Unduhan selesai!';
        } catch (e) {
            console.error('Download failed:', e);
            elements.downloadStatusBar.style.display = 'none';
            elements.downloadProgressText.textContent = 'Unduhan gagal!';
            elements.downloadLinks.style.display = 'flex';
        }
    }

    const videoData = getVideoData();

    if (videoData && videoData.title) {
        // Thumbnail & info
        elements.videoThumbnail.src = videoData.thumbnail || 'placeholder.jpg';
        elements.videoThumbnail.onerror = () => { elements.videoThumbnail.src = 'placeholder.jpg'; };
        elements.videoTitle.innerHTML = safeText(videoData.title || 'Video Tanpa Judul');
        elements.videoAuthor.innerHTML = safeText(videoData.author.nickname || 'Tidak Diketahui');

        elements.resultSection.style.display = 'block';
        elements.downloadLinks.innerHTML = '';
        
        if (videoData.links && videoData.links.length) {
            videoData.links.forEach(link => {
                const downloadLink = document.createElement('div');
                downloadLink.className = 'download-link';
                
                const downloadInfo = document.createElement('div');
                downloadInfo.className = 'download-info';

                const title = document.createElement('h3');
                const q = link.quality.toLowerCase();
                let qualityText = '';
                if (q === 'hd') {
                    qualityText = 'Video HD';
                } else if (q === 'sd') {
                    qualityText = 'Video SD';
                } else if (q === 'audio') {
                    qualityText = 'Audio MP3';
                }
                title.textContent = qualityText;

                const sizeInfo = document.createElement('p');
                sizeInfo.textContent = 'Menghitung ukuran...';
                
                downloadInfo.appendChild(title);
                downloadInfo.appendChild(sizeInfo);
                downloadLink.appendChild(downloadInfo);
                
                const downloadBtn = document.createElement('div');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = 'Unduh';
                downloadLink.appendChild(downloadBtn);

                fetch(link.url, { method: 'HEAD' })
                    .then(res => res.headers.get('Content-Length'))
                    .then(cl => {
                        if (cl) {
                            const mb = (cl / (1024 * 1024)).toFixed(2);
                            sizeInfo.textContent = `Ukuran: ${mb} MB`;
                            downloadBtn.addEventListener('click', () => {
                                const filename = `svtt_${Math.random().toString(36).substring(2, 15)}.${q === 'audio' ? 'mp3' : 'mp4'}`;
                                startDownload(link.url, filename, mb);
                            });
                        } else {
                            sizeInfo.textContent = 'Ukuran tidak diketahui';
                            downloadBtn.addEventListener('click', () => {
                                const filename = `svtt_${Math.random().toString(36).substring(2, 15)}.${q === 'audio' ? 'mp3' : 'mp4'}`;
                                startDownload(link.url, filename, 'N/A');
                            });
                        }
                    })
                    .catch(() => {
                        sizeInfo.textContent = 'Ukuran tidak diketahui';
                        downloadBtn.addEventListener('click', () => {
                            const filename = `svtt_${Math.random().toString(36).substring(2, 15)}.${q === 'audio' ? 'mp3' : 'mp4'}`;
                            startDownload(link.url, filename, 'N/A');
                        });
                    });
                
                elements.downloadLinks.appendChild(downloadLink);
            });
        } else {
            elements.downloadLinks.innerHTML = '<p class="text-muted">Tidak ada tautan unduhan ditemukan.</p>';
        }

    } else {
        elements.resultSection.style.display = 'none';
        showMessage('Gagal memuat data video. Silakan kembali ke halaman utama.');
    }
});
</script>
</body>
</html>
